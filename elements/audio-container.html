<link rel="import" href="audio-data.html">
<link rel="import" href="audio-player.html">

<dom-module id="audio-container">
  <template>
    <style>
      /*:host {
        display: none;
      }*/
      #mapChoise {
        position: fixed;
        bottom: 20px;
        left: 20px;
        color: #ddd;
        font-weight: bold;
      }
    </style>

    <audio-data id="loader" path="../audio/tones/piano/" amount=88 type="mp3"></audio-data>
    <audio-player id="player"></audio-player>

    <form id="mapChoise">
      <input type="radio" name="set" value="tones" checked> Tones </br>
      <input type="radio" name="set" value="chords"> Chords
    </form>

  </template>

  <script>
    class AudioContainer extends Polymer.Element {
      static get is() {
        return "audio-container";
      }
      static get config() {
        return {
          properties: {
            press: {
              type: String,
              observer: "_keysPress"
            },
            unpress: {
              type: String,
              observer: "_keysUnpress"
            },
            keyArray: {
              type: Array,
              value: function() {
                return [
									/*0*/"Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9", "Digit0", "Minus", "Equal",
                  /*12*/"KeyQ", "KeyW", "KeyE", "KeyR", "KeyT", "KeyY", "KeyU", "KeyI", "KeyO", "KeyP", "BracketLeft", "BracketRight",
                  /*24*/"KeyA", "KeyS", "KeyD", "KeyF", "KeyG", "KeyH", "KeyJ", "KeyK", "KeyL", "Semicolon", "Quote",
                  /*35*/"KeyZ", "KeyX", "KeyC", "KeyV", "KeyB", "KeyN", "KeyM", "Comma", "Period", "Slash"
                ]
              }
            },
            tonesMap : {
              type: Object,
              value: function() {
                return {
									KeyA: ["IV",0-1],
									KeyB: ["VI",0],
									KeyC: ["II",0],
									KeyD: ["I",0],
									KeyE: ["VII",0-1],
									KeyF: ["III",0],
									KeyG: ["V",0],
									KeyH: ["VII",1-1],
									KeyI: ["III",1],
									KeyJ: ["II",1],
									KeyK: ["IV",1],
									KeyL: ["VI",1],
									KeyM: ["III",1],
									KeyN: ["I",1],
									KeyO: ["V",1],
									KeyP: ["VII",1],
									KeyQ: ["III",0-1],
									KeyR: ["II",0],
									KeyS: ["VI",0-1],
									KeyT: ["IV",0],
									KeyU: ["I",1],
									KeyV: ["IV",0],
									KeyW: ["V",0-1],
									KeyX: ["VII",0-1],
									KeyY: ["VI",1-1],
									KeyZ: ["V",0-1],
									Semicolon: ["I",1+1],
									Comma: ["V",1],
									Period: ["VII",1],
									Slash: ["II",1+1],
									BracketLeft: ["II",1+1],
									BracketRight: ["IV",1+1],
									Quote: ["III",1+1]
                }
              }
            },
            chordsMap : {
              type: Object,
              value: function() {
                return {
									KeyA: ["IV",0-1],
									KeyB: ["vi",0],
									KeyC: ["ii",0],
									KeyD: ["I",0],
									KeyE: ["VII",0-1],
									KeyF: ["III",0],
									KeyG: ["V",0],
									KeyH: ["VII",1-1],
									KeyI: ["III",1],
									KeyJ: ["II",1],
									KeyK: ["IV",1],
									KeyL: ["VI",1],
									KeyM: ["iii",0],
									KeyN: ["I",0],
									KeyO: ["V",1],
									KeyP: ["VII",1],
									KeyQ: ["III",0-1],
									KeyR: ["II",0],
									KeyS: ["VI",0-1],
									KeyT: ["IV",0],
									KeyU: ["I",1],
									KeyV: ["IV",0],
									KeyW: ["V",0-1],
									KeyX: ["viiDim",0],
									KeyY: ["VI",1-1],
									KeyZ: ["V",0],
									Semicolon: ["I",1+1],
									Comma: ["V",0],
									Period: ["III",1],
									Slash: ["II",1+1],
									BracketLeft: ["II",1+1],
									BracketRight: ["IV",1+1],
									Quote: ["III",1+1]
                }
              }
            },
						tone: {
							type: String,
							reflectToAttribute: true
						},
            base: {
							type: String,
							reflectToAttribute: true
						},
            baseIndex: {
              type: Number,
              computed: "_baseToIndex(base)"
            },
            mode: {
							type: String,
							reflectToAttribute: true
						},
            modeIndex: {
              type: Number,
              computed: "_modeToIndex(mode)"
            },
             modePosition: {
               type: Number,
               value: 6             //VII (B)
             },
             modeName: {
               type: String,
               computed: "_getModularScaleName(scaIvar)",
               reflectToAttribute: true
             },
            modes: {
              type: Array,
              value: function() {
                return [
                  [[0, 2, 4, 6, 7, 9, 11], "lydian"],
                  [[0, 2, 4, 5, 7, 9, 11], "major"], //ionian I
                  [[0, 2, 4, 5, 7, 9, 10], "mixolydian"],
                  [[0, 2, 3, 5, 7, 9, 10], "dorian"],
                  [[0, 2, 3, 5, 7, 8, 10], "minor"], // aeolian VI
                  [[0, 1, 3, 5, 7, 8, 10], "phrygian"],
                  [[0, 1, 3, 5, 6, 8, 10], "locrian"]
                ];
              }
            },
             modularScale: {
               type: Array,
               value: function() {
                 return [0, 2, 4, 5, 7, 9, 11];
               }
             },
            shift: {
              type: Number,
              value: 0
            },
            keyModulate: {
              type: Number,
              value: 0,
              reflectToAttribute: true
            }
          }
        }
      }

      connectedCallback() {
        this._createKeyscale();
      }

      _keysPress() {
        if (!this.press) return;
        var key = this.press;
        if (key === "Tab" || key === "Enter") {
          this._funcTabEnter(key);
        } else if (key === "Backquote" || key === "Backspace") {
          this._funcBackBack(key);
        } else if (key === "ShiftLeft") {
          this._funcShiftLeft(1);
        } else {
          this._playTone(key);
        }
      }

      _keysUnpress() {
        if (this.unpress === "ShiftLeft") {
          this._funcShiftLeft(0);
        }
        // TODO: here would be the end of the long sound
      }

      _funcTabEnter(key) {
        this.keyModulate += (key === "Tab" ? 5 : 7);
        if (this.keyModulate > 11)
          this.keyModulate -= 12;
      }

      _funcShiftLeft(num) {
        this.shift = num;
      }

      _funcBackBack(key) {
        if (key === "Backquote") {
           this.modularScale[this.modePosition] = this.modularScale[this.modePosition]-1;
           this.modePosition -= 4;
           if (this.modePosition < 0)
             this.modePosition += 7;

          var index = this.modeIndex - 1;
          if (index < 0) {
            index = 6;
            this._displayTone([this._baseToIndex(this.base)-1, "base"]);
          }
          this.mode = this.modes[index][1];
        } else if (key === "Backspace") {
           this.modePosition += 4;
           if (this.modePosition > 6)
             this.modePosition -= 7;
           this.modularScale[this.modePosition] = this.modularScale[this.modePosition]+1;

          var index = this.modeIndex + 1;
          if (index > 6) {
            index = 0;
            this._displayTone([this._baseToIndex(this.base)+1, "base"]);
          }
          this.mode = this.modes[index][1];
        }
        this._createKeyscale();
        this.notifyPath("modularScale");
      }

      _createKeyscale() {
         this.modeArray = this.modularScale;
//        this.modeArray = this.modes[this.modeIndex][0];
        this.tones = {
          I: this.baseIndex+this.modeArray[0],
          II: this.baseIndex+this.modeArray[1],
          III: this.baseIndex+this.modeArray[2],
          IV: this.baseIndex+this.modeArray[3],
          V: this.baseIndex+this.modeArray[4],
          VI: this.baseIndex+this.modeArray[5],
          VII: this.baseIndex+this.modeArray[6]
        };
        this.chords = {
          I: [this.tones.I, this.tones.III, this.tones.V],
          ii: [this.tones.II,this.tones.IV,this.tones.VI],
          iii: [this.tones.III,this.tones.V,this.tones.VII],
          IV: [this.tones.IV,this.tones.VI,this.tones.I],
          V: [this.tones.V,this.tones.VII,this.tones.II],
          vi: [this.tones.VI,this.tones.I,this.tones.III],
          viiDim: [this.tones.VII,this.tones.II,this.tones.IV],
          //from statistical analysis of chords in hooktheory
          II: [this.tones.II,this.tones.IV+1,this.tones.VI],
          III: [this.tones.III,this.tones.V+1,this.tones.VII],
        }
      }

      _playTone(key){
        var codes = this._chordsOrTones(key);

        codes.forEach(function(code) {
          code = code + this.keyModulate;
          this.$.player.playTone(this.$.loader.files[code]);
        }.bind(this))
        this._displayTone(codes, "tone");
      }

      _chordsOrTones(key) {
        var mode = this.$.mapChoise.querySelector("[checked]").checked;
        var option = this.keyArray.indexOf(key) >= 35 && this.keyArray.indexOf(key) < 44;

        if (!mode && option)
          return this.chords[this.chordsMap[key][0]];

        return [this.tones[this.tonesMap[key][0]]+12*this.tonesMap[key][1]+this.shift+this.keyModulate];
      }

      _baseToIndex(base) {
        var notes = ["C","Db/C#","D","Eb/D#","E","F","Gb/F#","G","Ab/G#","A","Bb/A#","B"];
        var nBase = notes.indexOf(base.slice(0,-1));
        var oBase = base.slice(-1);
        var base = (nBase-9)+oBase*12;
        return base;
      }

      _modeToIndex(mode) {
        for (var i = 0; i < this.modes.length; i++) {
          if (this.modes[i][1] === mode) {
            return i;
          }
        }
      }

      _getModularScaleName(scaIvar) {
        var statScales = [
          [[0, 1, 3, 5, 6, 8, 10], "locrian"],
          [[0, 2, 3, 5, 7, 8, 10], "minor"], // aeolian VI
          [[0, 2, 4, 5, 7, 9, 10], "mixolydian"],
          [[0, 2, 4, 6, 7, 9, 11], "lydian"],
          [[0, 1, 3, 5, 7, 8, 10], "phrygian"],
          [[0, 2, 3, 5, 7, 9, 10], "dorian"],
          [[0, 2, 4, 5, 7, 9, 11], "major"] //ionian I
        ];
        return statScales[this.modePosition][1];
      }

      _displayTone(code, attr) {
        var notes = ["C", "Db/C#", "D", "Eb/D#", "E", "F", "Gb/F#", "G", "Ab/G#", "A", "Bb/A#", "B"];
        var names = code.map(function (each) {
          var nBase = (each + 9) % 12;
          var oBase = Math.floor((each + 9) / 12);
          return notes[nBase] + oBase;
        });
        this[attr] = names.join("|");
      }
    }
    customElements.define(AudioContainer.is, AudioContainer);
  </script>
</dom-module>