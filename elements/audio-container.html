<link rel="import" href="audio-data.html">
<link rel="import" href="audio-player.html">
<link rel="import" href="music-scale.html">
<link rel="import" href="music-clef.html">
<link rel="import" href="music-chord.html">

<dom-module id="audio-container">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <slot></slot>

    <music-clef mode="[[mode]]" key="[[key]]">
      <music-chord id="chords">
        <music-scale id="scale" mode="{{mode}}" key="{{key}}"></music-scale>
      </music-chord>
    </music-clef>
    <audio-data id="loader" path="../audio/tones/piano/" amount=88 type="mp3"></audio-data>
    <audio-player id="player"></audio-player>

  </template>

  <script>

    class AudioContainer extends Polymer.Element {
      static get is() {
        return "audio-container";
      }

      static get config() {
        return {
          properties: {
            tone: {
              type: String,
              reflectToAttribute: true
            },
            base: {
              type: String,
              observer: "parseBase"
            },
            mode: {
              type: String,
              reflectToAttribute: true
            },
            key: {
              type: String,
              reflectToAttribute: true
            },
            chordMode: {
              type: Boolean,
              value: false
            },
          }
        }
      }

      checkForCommands(key) {
        let div = this.querySelector("[data-key=" + key + "]");
        if (!div)
          return 0;

        switch (div.dataset.command) {
          case "turnKeyLeft":
            this.$.scale.turnKeyLeft();
            return 0;
          case "turnKeyRight":
            this.$.scale.turnKeyRight();
            return 0;
          case "turnModusLeft":
            this.$.scale.turnModusLeft();
            return 0;
          case "turnModusRight":
            this.$.scale.turnModusRight();
            return 0;
          case "sharpen":
            return 1;
        }
      }

      playKeys(press, arrayOfKeys) {
        let sharpen = 0;
        for (let key of arrayOfKeys) {
          if (this.checkForCommands(key.code) == 1)
            sharpen = 1;
        }
        this._keysPress(press, sharpen);
      }

      playFailure() {
        this.$.player.playTone(this.$.loader.getOther('failure'));
      }

      _keysPress(key, sharpen) {
        if (!key)
          return;

        let div = this.querySelector("[data-key=" + key + "]:not([data-command])");
        if (!div)
          return;

        let codes = this.chordMode && div.dataset.chord ?
          this.getChord(div.dataset.chord) :
          this.getTone(div.dataset.tone, div.dataset.octave, sharpen);
        this.tone = this.$.scale.numbersToNoteNames(codes);

        codes.forEach(function (code) {
          this.$.player.playTone(this.$.loader.getSound(this.getBase() + code));
        }.bind(this));
      }

      getTone(tone, octave, sharpen) {
        return [
          this.$.scale.getSevenToneNumber(Number(tone) - 1) +
          sharpen +
          Number(octave) * 12
        ];
      }

      //the 88 key piano starts with A, A#, B at the far right
      getBase() {
        return this.baseNote - 9 + this.baseOctave * 12;
      }

      parseBase(base) {
        this.baseNote = this.$.scale.getNotePositionNormal(base.slice(0, -1));
        this.baseOctave = Number(base.slice(-1));
      }

      //todo need to integrate the major II chord and major III chord from the hooktheory article
      //todo II: [this.tones.II, this.tones.IV + 1, this.tones.VI],
      //todo III: [this.tones.III, this.tones.V + 1, this.tones.VII],
      getChord(numberAsText) {
        return this.$.chords.getChord(Number(numberAsText) - 1);
      }
    }
    customElements.define(AudioContainer.is, AudioContainer);
  </script>
</dom-module>