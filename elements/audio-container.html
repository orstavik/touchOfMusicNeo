<link rel="import" href="audio-data.html">
<link rel="import" href="audio-player.html">
<link rel="import" href="music-scale.html">

<dom-module id="audio-container">
  <template>
    <style>
      /*:host {
        display: none;
      }*/
      #mapChoise {
        position: fixed;
        bottom: 20px;
        left: 20px;
        color: #ddd;
        font-weight: bold;
      }

      ::slotted(*) {
        display: none
      }
    </style>

    <slot></slot>

    <music-scale id="scale" base="[[base]]" mode="{{modeName}}" key="{{keyName}}"></music-scale>
    <audio-data id="loader" path="../audio/tones/piano/" amount=88 type="mp3"></audio-data>
    <audio-player id="player"></audio-player>

    <form id="mapChoise">
      <input type="radio" name="set" value="tones" checked> Tones </br>
      <input type="radio" name="set" value="chords"> Chords
    </form>

  </template>

  <script>

    class AudioContainer extends Polymer.Element {
      static get is() {
        return "audio-container";
      }

      static get config() {
        return {
          properties: {
            press: {
              type: String,
              observer: "_keysPress"
            },
            unpress: {
              type: String,
              observer: "_keysUnpress"
            },
            tone: {
              type: String,
              reflectToAttribute: true
            },
            base: {
              type: String
            },
            modeName: {
              type: String,
              reflectToAttribute: true
            },
            keyName: {
              type: String,
              reflectToAttribute: true
            },
            shift: {
              type: Number,
              value: 0
            }
          }
        }
      }

      _keysPress() {
        if (!this.press)
          return;
        switch (this.press) {
          case "Tab":
            return this.$.scale.turnKeyLeft();
          case "Enter":
            return this.$.scale.turnKeyRight();
          case "Backquote":
            return this.$.scale.turnModusLeft();
          case "Backspace":
            return this.$.scale.turnModusRight();
          case "ShiftLeft":
            return this.shift = 1;
        }

        let div = this.querySelector("[data-key=" + this.press + "]");
        if (!div)
          return;

        let codes = div.dataset.chord && !this.$.mapChoise.querySelector("[checked]").checked ?
          this.$.scale.getChord(div.dataset.chord) :
          [this.$.scale.getTone(div.dataset.tone) + (12 * div.dataset.octave) + this.shift];
        this.tone = this.$.scale.numbersToNoteNames(codes);

        codes.forEach(function (code) {
          this.$.player.playTone(this.$.loader.getSound(code));
        }.bind(this));
      }

      _keysUnpress() {
        if (this.unpress === "ShiftLeft")
          this.shift = 0;
        // TODO: here would be the end of the long sound
      }
    }
    customElements.define(AudioContainer.is, AudioContainer);
  </script>
</dom-module>