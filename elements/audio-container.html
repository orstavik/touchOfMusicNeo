<link rel="import" href="audio-data.html">
<link rel="import" href="audio-player.html">
<link rel="import" href="music-scale.html">

<dom-module id="audio-container">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
    
    <slot></slot>

    <music-scale id="scale" base="[[base]]" mode="{{mode}}" key="{{key}}" root-tone="{{rootTone}}"></music-scale>
    <audio-data id="loader" path="../audio/tones/piano/" amount=88 type="mp3"></audio-data>
    <audio-player id="player"></audio-player>

  </template>

  <script>

    class AudioContainer extends Polymer.Element {
      static get is() {
        return "audio-container";
      }

      static get config() {
        return {
          properties: {
            pressed: {
              type: Array,
              value: function() {
                return []
              },
              observer: "_pressedHaveChanged"
            },
            bufferPressed: {
              type: Array,
              value: function() {
                return []
              }
            },
            tone: {
              type: String,
              reflectToAttribute: true
            },
            base: {
              type: String
            },
            mode: {
              type: String,
              reflectToAttribute: true
            },
            key: {
              type: String,
              reflectToAttribute: true
            },
            rootTone: {
              type: String,
              reflectToAttribute: true
            },
            sharp: {
              type: Number,
              value: 0
            },
            chordMode: {
              type: Boolean,
              value: false
            },
            bool: Boolean,
            tempo: {
              type: Number,
              observer: "_runMetronome"
            }
          }
        }
      }

      _pressedHaveChanged() {
        var nev = this.pressed;
        var old = this.bufferPressed;
        if (nev.length > old.length) {
          this._keysPress(nev[nev.length-1]);
        }
        else if (nev.length < old.length) {
          for (let i = 0; i < old.length; i++) {
            if (nev.indexOf(old[i]) == -1) {
              this._keysUnpress(old[i]);
            }
          }
        }
        this.bufferPressed = this.pressed;
      }

      _keysPress(key) {
        if (!key)
          return;

        let div = this.querySelector("[data-key=" + key + "]");
        if (!div)
          return;
          
        switch (div.dataset.command) {
          case "turnKeyLeft":
            return this.$.scale.turnKeyLeft();
          case "turnKeyRight":
            return this.$.scale.turnKeyRight();
          case "turnModusLeft":
            return this.$.scale.turnModusLeft();
          case "turnModusRight":
            return this.$.scale.turnModusRight();
          case "sharpen":
            this.sharp = 1;
            return;
        }

        if (!this.bool) {
          this.$.player.playTone(this.$.loader.getOther("failure"));
          return;
        }

        let codes = this.chordMode && div.dataset.chord ?
          this.$.scale.getChord(div.dataset.chord) :
          [this.$.scale.getTone(div.dataset.tone, div.dataset.octave, this.sharp)];
        this.tone = this.$.scale.numbersToNoteNames(codes);

        codes.forEach(function (code) {
          this.$.player.playTone(this.$.loader.getSound(code));
        }.bind(this));
      }

      _runMetronome() {
        setInterval(function() {
          this.$.player.playTone(this.$.loader.getOther("beat"));
        }.bind(this), this.tempo*10);
      }

      _keysUnpress(key) {
        let div = this.querySelector("[data-key=" + key + "]");
        if (!div)
          return;
        switch (div.dataset.command) {
          case "sharpen":
            this.sharp = 0;
            break;
        }
      }
    }
    customElements.define(AudioContainer.is, AudioContainer);
  </script>
</dom-module>