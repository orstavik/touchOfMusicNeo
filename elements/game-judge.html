<dom-module id="game-judge">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <slot on-tick="_countTick" on-pressed-keys="_registerKeys" on-joievent="_holdEvents"></slot>

  </template>

  <script>
    class GameJudge extends Polymer.Element {
      static get is() {
        return "game-judge";
      }

      static get config() {
        return {
          properties: {
            ticksPerTurn: {
              type: Number,
              value: 10
            },
            heldEvents: {
              type: Object,
              value: function () {
                return {};
              }
            },
            registerEvents: {
              type: Array,
              value: function() {
                return []
              }
             },
            keys: {
              type: Array,
              value: function() {
                return []
              }
            },
            keysBuffer: {
              type: Array,
              value: function() {
                return []
              }
            }
          }
        }
      }

      _holdEvents(e) {
        e.stopPropagation();
        e.preventDefault();
        let eid = e.detail.id;
        if (this.registerEvents[eid])
          return
        else
          this.registerEvents[eid] = true;
        if (e.detail.duration) { //duration exists and is not 0
          this.heldEvents[eid] = {
            ticksLeft: e.detail.duration * this.ticksPerTurn,
            event: e  
          };
        }
      }

      _countTick(e) {
        for (let hostage in this.heldEvents) {
          let evt = this.heldEvents[hostage];
          evt.ticksLeft--;
          if (evt.ticksLeft <= 0) {
            this.dispatchEvent(new CustomEvent(evt.event.type, evt.event));
            delete this.heldEvents[hostage];
          }
        }
      }

      _registerKeys(e) {
        let canons = this.querySelectorAll("joievent-canon");
        this.keys = JSON.parse(JSON.stringify(e.detail.pressed));
        var nev = this.keys;
        var old = this.keysBuffer;
        if (nev.length > old.length) {
          for (let id in this.heldEvents) {
            if ("Key"+this.heldEvents[id].event.detail.letter === nev[nev.length-1]) {
              console.log("true")
              this.querySelector("#keyboard").pressedAction(e);
            }
            else console.log("false")
          }
        } else if (nev.length < old.length) {
          this.querySelector("#keyboard").pressedAction(e);
        }
        this.keysBuffer = this.keys;
      }
    }
    customElements.define(GameJudge.is, GameJudge);
  </script>
</dom-module>