<dom-module id="game-judge">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <slot on-tick="_countTick" on-pressed-keys="_registerKeys" on-joievent="_holdEvents"></slot>

  </template>

  <script>
    class GameJudge extends Polymer.Element {
      static get is() {
        return "game-judge";
      }

      static get config() {
        return {
          properties: {
            ticksPerTurn: {
              type: Number,
              value: 10
            },
            heldEvents: {
              type: Object,
              value: function () {
                return {};
              }
            },
            registerEvents: {
              type: Array,
              value: function () {
                return [];
              }
            },
            keys: {
              type: Array,
              value: function () {
                return [];
              }
            },
            keysBuffer: {
              type: Array,
              value: function () {
                return [];
              }
            }
          }
        }
      }

      _holdEvents(e) {
        e.stopPropagation();
        e.preventDefault();
        let eid = e.detail.id;
        if (this.registerEvents[eid])
          return;
        else
          this.registerEvents[eid] = true;
        if (e.detail.duration) { //duration exists and is not 0
          this.heldEvents[eid] = {
            ticksLeft: e.detail.duration * this.ticksPerTurn,
            event: e
          };
        }
      }

      _countTick(e) {
        for (let hostage in this.heldEvents) {
          let evt = this.heldEvents[hostage];
          evt.ticksLeft--;
          if (evt.ticksLeft <= 0) {
            this.dispatchEvent(new CustomEvent(evt.event.type, evt.event));
            delete this.heldEvents[hostage];
          }
        }
      }

      _registerKeys(e) {
        let canons = this.querySelectorAll("joievent-canon");
        let heldArray = [];
        for (let i in this.heldEvents)
          heldArray.push("Key" + this.heldEvents[i].event.detail.letter);

        let press = this._checkDown(e, heldArray.length);
        let havePressed = press && press.length == heldArray.length;
        if (havePressed) {
          let bool = press.sort().toString() == heldArray.sort().toString();
          if (bool)
            this.querySelector("#keyboard").$.beams.prepareBeam(press);
          this.querySelector("#keyboard").pressedAction(e, bool);
        } else {
          this.querySelector("#keyboard").pressedAction(e);
        }
      }

      _checkDown(e, n) {
        this.keys = JSON.parse(JSON.stringify(e.detail.heldKeys));
        let nev = this.keys;
        let old = this.keysBuffer;
        this.keysBuffer = this.keys;
        if (nev.length > old.length) {
          if (nev.length > n) {
            return nev.splice(-n);
          } else {
            return nev;
          }
        } else if (nev.length < old.length) {
          return false;
        }
      }
    }
    customElements.define(GameJudge.is, GameJudge);
  </script>
</dom-module>