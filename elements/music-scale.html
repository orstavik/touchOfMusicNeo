<link rel="import" href="audio-data.html">
<link rel="import" href="audio-player.html">

<dom-module id="music-scale">
    <template>
        <style>
            :host {
              display: none;
            }
        </style>
    </template>
    <script>

      class MusicScale extends Polymer.Element {
        static get is() {
          return "music-scale";
        }

        static get config() {
          return {
            properties: {
              base: {
                type: String,
                observer: "setup"
              },
              rootTone: {
                type: String,
                notify: true,
                computed: "_calcRoot(base, mode)"
              },
              mode: {
                type:String,
                notify: true,
              },
              key: {
                type:String,
                notify: true,
              }
            }
          }
        }

        constructor(){
          super();
          this.staticNotes = ["C", "Db/C#", "D", "Eb/D#", "E", "F", "Gb/F#", "G", "Ab/G#", "A", "Bb/A#", "B"];
          this.staticWheelOfFifth = ["C", "G", "D", "A", "E", "B", "Gb/F#","Db/C#", "Ab/G#", "Eb/D#", "Bb/A#", "F"];
          this.staticScales = [
            [[0, 1, 3, 5, 6, 8, 10], "locrian"],
            [[0, 2, 3, 5, 7, 8, 10], "minor"], // aeolian VI
            [[0, 2, 4, 5, 7, 9, 10], "mixolydian"],
            [[0, 2, 4, 6, 7, 9, 11], "lydian"],
            [[0, 1, 3, 5, 7, 8, 10], "phrygian"],
            [[0, 2, 3, 5, 7, 9, 10], "dorian"],
            [[0, 2, 4, 5, 7, 9, 11], "major"] //ionian I
          ];
          this.staticModeOrderForChords = ["major", "dorian", "phrygian", "lydian", "mixolydian", "minor", "locrian"]; //todo same as above but in reverse order
          this.staticChords = ["maj", "maj", "min", "min", "maj", "min", "dim"];
        }

        setup() {
          this.baseIndex = this.noteNameToNumber(this.base);
          this.keyModulate = 0;
          this.modePosition = 6;        //start with major, first to be flattened is B, first to sharpen is F
          this.modularScale = this.staticScales[this.modePosition][0];
          this.mode = this.staticScales[this.modePosition][1];
        }

        noteNameToNumber(base) {
          let note = this.staticNotes.indexOf(base.slice(0, -1));
          let octave = base.slice(-1);
          return (note - 9) + octave * 12;
        }

        noteNameToNumber12Scale(noteName){
          return this.staticNotes.indexOf(noteName);
        }

        noteNameToNumberWheelOf5(noteName){
          return this.staticWheelOfFifth.indexOf(noteName);
        }

        noteNameToNumber7(noteName, mode, key) {

        }

        numbersToNoteNames(notes) {
          let noteNames = this.staticNotes;
          let names = notes.map(function (noteNumber) {
            let num = noteNumber + 9;
            return noteNames[(num % 12)] + Math.floor(num / 12);
          });
          return names.join("|");
        }

        //only uses sharp
        //to calculate the note color, use just HSL colors as below
        //noteColor = hsl(notePosition/12*360, 100, 67);
        getNotePositionInWheelOf5ByName(noteName){
          return this.staticWheelOfFifth.indexOf(noteName);
        }

        getNotePositionNormal(noteName){
          return this.staticNotes.indexOf(noteName);
        }

        turnModusRight() {
          this.modePosition += 4;
          if (this.modePosition > 6)
            this.modePosition -= 7;
          this.modularScale[this.modePosition] = this.modularScale[this.modePosition] + 1;
          this.mode = this.staticScales[this.modePosition][1];
        }

        turnModusLeft() {
          this.modularScale[this.modePosition] = this.modularScale[this.modePosition] - 1;
          this.modePosition -= 4;
          if (this.modePosition < 0)
            this.modePosition += 7;
          this.mode = this.staticScales[this.modePosition][1];
        }

        turnKeyRight() {
          this.keyModulate += 7;
          if (this.keyModulate > 11)
            this.keyModulate -= 12;
          this.key = this.staticNotes[this.keyModulate];
        }

        turnKeyLeft() {
          this.keyModulate += 5;
          if (this.keyModulate > 11)
            this.keyModulate -= 12;
          this.key = this.staticNotes[this.keyModulate];
        }

        getSevenTone(numberOneToSeven){
          return this.baseIndex + this.modularScale[numberOneToSeven-1];
        }

        /*neutralSharpOrFlat: flat=-1, neutral=0, sharp=1*/
        getTone(romanTone, octave, neutralSharpOrFlat) {
          return this.getSevenTone(romanTone) + octave *12 + this.keyModulate + neutralSharpOrFlat;
        }

        //todo need to integrate the major II chord and major III chord from the hooktheory article
//            II: [this.tones.II, this.tones.IV + 1, this.tones.VI],
//            III: [this.tones.III, this.tones.V + 1, this.tones.VII],
        getChord(root) {
          root--;
          let third = (root + 2) % 7;
          let fifth = (root + 4) % 7;
          let res = [this.baseIndex +this.modularScale[root], this.baseIndex +this.modularScale[third], this.baseIndex +this.modularScale[fifth]];
          return res;
        }

        getChordType(modeName, noteName) {
          let twelveNoteNumber = this.staticNotes.indexOf(noteName);
          let sevenNoteNumber = this.modularScale.indexOf(twelveNoteNumber);
          return this.getChordTypeByNumber(modeName, sevenNoteNumber);
        }
        getChordTypeByNumber(modeName, noteNumberZeroToSix) {
          let modeNumber = this.staticModeOrderForChords.indexOf(modeName);
          if (modeNumber == -1)
            throw new Error("Illegal mode name, use one of: " + this.staticModeOrderForChords.join(", ") +".");
          let chordNumber = (modeNumber + noteNumberZeroToSix) % 7;
          return this.staticChords[chordNumber];
        }

        _calcRoot(base, mode) {
          if (!this.modularScale) return this.base;
          else return this.numbersToNoteNames([this.baseIndex+this.modularScale[0]]);
        }
      }
      customElements.define(MusicScale.is, MusicScale);
    </script>
</dom-module>