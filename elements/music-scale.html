<dom-module id="music-scale">
    <template>
        <style>
            :host {
              display: none;
            }
        </style>
    </template>
    <script>

      class MusicScale extends Polymer.Element {
        static get is() {
          return "music-scale";
        }

        static get config() {
          return {
            properties: {
              base: {
                type: String,
                observer: "setup"
              },
              rootTone: {
                type: String,
                notify: true,
                computed: "_calcRoot(base, mode)"
              },
              mode: {
                type:String,
                notify: true,
              },
              key: {
                type:String,
                notify: true,
              }
            }
          }
        }

        constructor(){
          super();
          this.staticNotes = ["C", "Db/C#", "D", "Eb/D#", "E", "F", "Gb/F#", "G", "Ab/G#", "A", "Bb/A#", "B"];
          this.staticWheelOfFifth = ["C", "G", "D", "A", "E", "B", "Gb/F#","Db/C#", "Ab/G#", "Eb/D#", "Bb/A#", "F"];
          this.staticScales = [
            [[0, 1, 3, 5, 6, 8, 10], "locrian"],
            [[0, 2, 3, 5, 7, 8, 10], "minor"], // aeolian VI
            [[0, 2, 4, 5, 7, 9, 10], "mixolydian"],
            [[0, 2, 4, 6, 7, 9, 11], "lydian"],
            [[0, 1, 3, 5, 7, 8, 10], "phrygian"],
            [[0, 2, 3, 5, 7, 9, 10], "dorian"],
            [[0, 2, 4, 5, 7, 9, 11], "major"] //ionian I
          ];
        }

        setup() {
          this.baseIndex = this.noteNameToNumber(this.base);
          this.modePosition = 6;        //start with major, first to be flattened is B, first to sharpen is F
          this.modularScale = this.staticScales[this.modePosition][0];
          this.mode = this.staticScales[this.modePosition][1];
        }

        getSevenNoteNumber(noteName) {
          return this.modularScale.indexOf(this.staticNotes.indexOf(noteName));
        }

        getSevenToneNumber(zeeroToSix){
          return this.modularScale[zeeroToSix];
        }

        noteNameToNumber(base) {
          let note = this.staticNotes.indexOf(base.slice(0, -1));
          let octave = base.slice(-1);
          return (note - 9) + octave * 12;
        }

        numbersToNoteNames(notes) {
          let noteNames = this.staticNotes;
          let names = notes.map(function (noteNumber) {
            let num = noteNumber + 9;
            return noteNames[(num % 12)] + Math.floor(num / 12);
          });
          return names.join("|");
        }

        //only uses sharp
        //to calculate the note color, use just HSL colors as below
        //noteColor = hsl(notePosition/12*360, 100, 67);
        getNotePositionInWheelOf5ByName(noteName){
          return this.staticWheelOfFifth.indexOf(noteName);
        }

        getNotePositionNormal(noteName){
          return this.staticNotes.indexOf(noteName);
        }

        turnModusRight() {
          this.modePosition += 4;
          if (this.modePosition > 6)
            this.modePosition -= 7;
          this.modularScale[this.modePosition] = this.modularScale[this.modePosition] + 1;
          this.mode = this.staticScales[this.modePosition][1];  //todo is this the right mode position??
        }

        turnModusLeft() {
          this.modularScale[this.modePosition] = this.modularScale[this.modePosition] - 1;
          this.modePosition -= 4;
          if (this.modePosition < 0)
            this.modePosition += 7;
          this.mode = this.staticScales[this.modePosition][1]; //todo is this the right mode position??
        }

        turnKeyRight() {
          let value = this.modularScale[0] > 4 ? -5 : 7;
          for(let i = 0;i <this.modularScale.length; i++)
            this.modularScale[i]+= value;
          this.key = this.staticNotes[this.modularScale[0]];
        }

        turnKeyLeft() {
          let value = this.modularScale[0] > 6 ? -7 : 5;
          for(let i = 0;i <this.modularScale.length; i++)
            this.modularScale[i]+= value;
          this.key = this.staticNotes[this.modularScale[0]];
        }

        _calcRoot(base, mode) {
          return this.modularScale ?
            this.numbersToNoteNames([this.baseIndex + this.modularScale[0]]) :
            this.base;
        }
      }
      customElements.define(MusicScale.is, MusicScale);
    </script>
</dom-module>