<link rel="import" href="keyboard-visual.html">
<link rel="import" href="key-pyramid.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="beam-constructor.html">
<link rel="import" href="audio-synthesizer.html">
<link rel="import" href="audio-container.html">
<link rel="import" href="monster-container.html">
<script src="../scripts/Finger.js"></script>

<dom-module id="keyboard-container">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

		<keyboard-visual id="keyboard">
			<template is="dom-repeat" items="[[keyArray]]">
				<key-visual code$="[[item]]" row="[[_getRow(item)]]" index="[[index]]">
					<key-pyramid id="pyramid" char$="[[_codeToChar(item)]]" pressed$="[[pressed]]" active="[[futures]]"	class$="[[_getFingerName(item)]]"></key-pyramid>
				</key-visual>
			</template>
			<beam-constructor id="beams"></beam-constructor>
		</keyboard-visual>



		<monster-container id="monster"></monster-container>

		<keyboard-listener on-pressed-keys="_pressedAction" on-key-pressed="_press" on-key-unpressed="_unpress"></keyboard-listener>

    <!--<audio-synthesizer instrument="piano" keys="[[pressedArray]]"></audio-synthesizer>-->

    <audio-container press="[[pressedKey]]" unpress="[[unpressedKey]]" base="C3" mode="major"></audio-container>

  </template>

  <script>
    class KeyboardContainer extends Polymer.Element {
      static get is() {
        return "keyboard-container";
      }
      static get config() {
        return {
          properties: {
            futures: String,
            keyArray: {
              type: Array,
              value: function() {
                return [
									"Digit1", "Digit2", "Digit3", "Digit4", "Digit5", "Digit6", "Digit7", "Digit8", "Digit9", "Digit0", "Minus", "Equal",
                  "KeyQ", "KeyW", "KeyE", "KeyR", "KeyT", "KeyY", "KeyU", "KeyI", "KeyO", "KeyP", "BracketLeft", "BracketRight",
                  "KeyA", "KeyS", "KeyD", "KeyF", "KeyG", "KeyH", "KeyJ", "KeyK", "KeyL", "Semicolon", "Quote",
                  "KeyZ", "KeyX", "KeyC", "KeyV", "KeyB", "KeyN", "KeyM", "Comma", "Period", "Slash"
                ]
              }
            },
            pressedArray: {
              type: Array,
              value: function() {
                return []
              },
							observer: "_highlightKeys"
            },
            pressedKey: String,
            unpressedKey: String,
						keyValues: {
							type: Object,
							value: function() {
								return {
									KeyA: {key: 'a', shiftKey: 'A'},
									KeyB: {key: 'b', shiftKey: 'B'},
									KeyC: {key: 'c', shiftKey: 'C'},
									KeyD: {key: 'd', shiftKey: 'D'},
									KeyE: {key: 'e', shiftKey: 'E'},
									KeyF: {key: 'f', shiftKey: 'F'},
									KeyG: {key: 'g', shiftKey: 'G'},
									KeyH: {key: 'h', shiftKey: 'H'},
									KeyI: {key: 'i', shiftKey: 'I'},
									KeyJ: {key: 'j', shiftKey: 'J'},
									KeyK: {key: 'k', shiftKey: 'K'},
									KeyL: {key: 'l', shiftKey: 'L'},
									KeyM: {key: 'm', shiftKey: 'M'},
									KeyN: {key: 'n', shiftKey: 'N'},
									KeyO: {key: 'o', shiftKey: 'O'},
									KeyP: {key: 'p', shiftKey: 'P'},
									KeyQ: {key: 'q', shiftKey: 'Q'},
									KeyR: {key: 'r', shiftKey: 'R'},
									KeyS: {key: 's', shiftKey: 'S'},
									KeyT: {key: 't', shiftKey: 'T'},
									KeyU: {key: 'u', shiftKey: 'U'},
									KeyV: {key: 'v', shiftKey: 'V'},
									KeyW: {key: 'w', shiftKey: 'W'},
									KeyX: {key: 'x', shiftKey: 'X'},
									KeyY: {key: 'y', shiftKey: 'Y'},
									KeyZ: {key: 'z', shiftKey: 'Z'},
									Digit0: { key: '0', shiftKey: ')' },
									Digit1: { key: '1', shiftKey: '!' },
									Digit2: { key: '2', shiftKey: '@' },
									Digit3: { key: '3', shiftKey: '#' },
									Digit4: { key: '4', shiftKey: '$' },
									Digit5: { key: '5', shiftKey: '%' },
									Digit6: { key: '6', shiftKey: '^' },
									Digit7: { key: '7', shiftKey: '&' },
									Digit8: { key: '8', shiftKey: '*' },
									Digit9: { key: '9', shiftKey: '(' },
									Equal: { key: '=', shiftKey: '+' },
									Minus: { key: '-', shiftKey: '_' },
									Semicolon: {key: ';', shiftKey: ':'},
									Comma: {key: ',', shiftKey: '<'},
									Period: {key: '.', shiftKey: '>'},
									Slash: {key: '/', shiftKey: '?'},
									BracketLeft: {key: '[', shiftKey: '{'},
									BracketRight: {key: ']', shiftKey: '}'},
									Quote: {key: '\'', shiftKey: '"'}
								}
							}
						},
						fingerInfo: {
							type: Object,
							value: function() {
								return {
									KeyA: new Finger ({row: 0, finger: 9, alt: 0}),
									KeyB: new Finger ({row: -1, finger: 1, alt: 2}),
									KeyC: new Finger ({row: -1, finger: 6, alt: 0}),
									KeyD: new Finger ({row: 0, finger: 7, alt: 0}),
									KeyE: new Finger ({row: 1, finger: 7, alt: 0}),
									KeyF: new Finger ({row: 0, finger: 6, alt: 0}),
									KeyG: new Finger ({row: 0, finger: 6, alt: 1}),
									KeyH: new Finger ({row: 0, finger: 1, alt: 1}),
									KeyI: new Finger ({row: 1, finger: 2, alt: 0}),
									KeyJ: new Finger ({row: 0, finger: 1, alt: 0}),
									KeyK: new Finger ({row: 0, finger: 2, alt: 0}),
									KeyL: new Finger ({row: 0, finger: 3, alt: 0}),
									KeyM: new Finger ({row: -1, finger: 1, alt: 0}),
									KeyN: new Finger ({row: -1, finger: 1, alt: 1}),
									KeyO: new Finger ({row: 1, finger: 3, alt: 0}),
									KeyP: new Finger ({row: 1, finger: 4, alt: 0}),
									KeyQ: new Finger ({row: 1, finger: 9, alt: 0}),
									KeyR: new Finger ({row: 1, finger: 6, alt: 0}),
									KeyS: new Finger ({row: 0, finger: 8, alt: 0}),
									KeyT: new Finger ({row: 1, finger: 6, alt: 1}),
									KeyU: new Finger ({row: 1, finger: 1, alt: 0}),
									KeyV: new Finger ({row: -1, finger: 6, alt: 1}),
									KeyW: new Finger ({row: 1, finger: 8, alt: 0}),
									KeyX: new Finger ({row: -1, finger: 7, alt: 0}),
									KeyY: new Finger ({row: 1, finger: 1, alt: 1}),
									KeyZ: new Finger ({row: -1, finger: 8, alt: 0}),
									Digit0: new Finger ({row: 2, finger: 4, alt: 0}),
									Digit1: new Finger ({row: 2, finger: 9, alt: 1}),
									Digit2: new Finger ({row: 2, finger: 9, alt: 0}),
									Digit3: new Finger ({row: 2, finger: 8, alt: 0}),
									Digit4: new Finger ({row: 2, finger: 7, alt: 0}),
									Digit5: new Finger ({row: 2, finger: 6, alt: 0}),
									Digit6: new Finger ({row: 2, finger: 6, alt: 1}),
									Digit7: new Finger ({row: 2, finger: 1, alt: 0}),
									Digit8: new Finger ({row: 2, finger: 2, alt: 0}),
									Digit9: new Finger ({row: 2, finger: 3, alt: 0}),
									Equal: new Finger ({row: 2, finger: 4, alt: 2}),
									Minus: new Finger ({row: 2, finger: 4, alt: 1}),
									Semicolon: new Finger ({row: 0, finger: 4, alt: 0}),
									Comma: new Finger ({row: -1, finger: 2, alt: 0}),
									Period: new Finger ({row: -1, finger: 3, alt: 0}),
									Slash: new Finger ({row: -1, finger: 4, alt: 0}),
									BracketLeft: new Finger ({row: 1, finger: 4, alt: 1}),
									BracketRight: new Finger ({row: 1, finger: 4, alt: 2}),
									Quote: new Finger ({row: 0, finger: 4, alt: 1}),
								}
							}
						},
						monsterRect: Object
          }
        }
      }

      _pressedAction(e) {
        this.pressedArray = e.detail.pressed;

				this._prepareBeam();
      }

			_press(e) {
				this.pressedKey = e.detail.pressed;
				this.history = !this.history ? "" : this.history;
				var char = this.keyValues[e.detail.pressed];
				if (char)
					this.history += char.key.toUpperCase()+" ";
				// console.log(this.history);
			}

      _unpress(e) {
				this.unpressedKey = "";
				this.unpressedKey = e.detail.pressed;
				if (this.unpressedKey == this.pressedKey) {
          this.pressedKey = undefined;
        }
      }

			_prepareBeam() {
				var keyNode, keyParent, finger, origin, target;
				var keys = this.pressedArray;
				for(var i = 0; i < keys.length; i++) {
					keyNode = this.$.keyboard.querySelector("[code="+keys[i]+"]");
					if (keyNode) {
						finger = this._getFingerName(keys[i]);
						origin = keyNode.children[0].getRect();
						target = this.$.monster.getRect();
						if (origin && target)
							this.$.beams.constructBeam(origin,target,finger);
					}
				}
			}

			_getFingerName(item) {
				return this.fingerInfo[item].fingerName();
			}

			_codeToChar(code) {
				return this.keyValues[code].key.toUpperCase();
			}

			_getRow(code) {
				return this.fingerInfo[code].row;
			}

			_highlightKeys() {
				var pressedKeys = this.$.keyboard.querySelectorAll("[pressed]");
				for(var i = 0; i < pressedKeys.length; i++) {
					pressedKeys[i].removeAttribute("pressed");
				}

				for(i = 0; i < this.pressedArray.length; i++) {
					var index = this.keyArray.indexOf(this.pressedArray[i]);
					var keyElem = this.$.keyboard.children[index];
					if (keyElem)
						keyElem.setAttribute("pressed", true);
				}
			}

			readFutures(i) {
				// debugger;
				// var futureNodes = this.$.keyboard.querySelectorAll("[futures]");
				// futureNodes.forEach(function(elem) {
				// 	if (elem.active < 3)
				// 		elem.active++;
				// }.bind(this));
				// if (this.futures) {
				// 	var key = this.futures[i];
				// 	if (!key) return;
				// 	var keyNode = this.$.keyboard.querySelector('[char="'+key+'"]');
				// 	keyNode.active = 0;
				// }
			}
    }
    customElements.define(KeyboardContainer.is, KeyboardContainer);
  </script>
</dom-module>