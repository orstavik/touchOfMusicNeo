<link rel="import" href="keyevents-listener.html">

<dom-module id="keyboard-listener">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>

    <keyevents-listener id="listener" on-key-down="_keyWasDown" on-key-up="_keyWasUp"></keyevents-listener>

  </template>

  <script>

    class KeyEventsLog {
      constructor() {
        this.log = [];
      }

      addEvent(e) {
        if (this.log.length > 0) {
          let last = this.log[this.log.length-1];
          if (last.code === e.code && last.type === e.type && last.state === "pressed")
            return;
        }
        let key = new KeyEvent(e.code, e.type, e.timeStamp);
        this.log.push(key);
        this.last = key;
        if (e.type === "key-up") {
          this._releaseKey(e);
        } else {
          this._setIntervals(e.timeStamp);
        }
        console.log(this.last);
        return true;
      }

      _releaseKey(e) {
        this.log.find(function(key) {
          if (key.code === e.code && key.state === "pressed") {
            key.state = "released";
            key.duration = e.timeStamp - key.timeStamp;
          }
        });
      }

      getPressed() {
        return this.log.filter(function(key) {
          if (key.state === "pressed") {
            return key;
          }
        })
      }

      _setIntervals(timeStamp) {
        if (this.log.length === 0) return;
        let lastDown, lastUp;
        for (let i = this.log.length-2; i >= 0; i--) {
          if (this.log[i].type === "key-down" && !lastDown) {
            lastDown = this.log[i];
            this.last.timeAfterLastKeyDown = timeStamp - lastDown.timeStamp;
          } else if (this.log[i].type === "key-up" && !lastUp) {
            lastUp = this.log[i];
            this.last.timeAfterLastKeyUp = timeStamp - lastUp.timeStamp;
          }
          if (lastDown && lastUp)
            break;
        }
      }
    }

    // class KeyEvent {
    //   constructor(code, start, end) {
    //     this.code = code;
    //     this.duration = end - start;
    //     this.start = start;
    //     this.stop = end;
    //   }
    // }

    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }

      static get config() {
        return {
          properties: {
            history: {
              type: KeyEventsLog,
              value: function() {
                return new KeyEventsLog();
              }
            },
          }
        }
      }

      connectedCallback() {
        const keyDowns = Observable.fromEvent(this.$.listener, 'key-down');
        const keyUps = Observable.fromEvent(this.$.listener, 'key-up');
        this.keyEvents = this._getDebounced(keyDowns.merge(keyUps));
        this.keyEvents2 = this._mergeUpDown(this.keyEvents);
        
        this.keyEvents.subscribe((event) => console.log(event));
        this.keyEvents2.subscribe((e) => console.log(e));
      }

      _getDebounced(collection) {
        var lastKey = {};
        return collection.filter(function(key) {
          if (key.code !== lastKey.code || key.type !== lastKey.type) {
            lastKey = key;
            return true;
          }
          return false;
        })
      }

      _mergeUpDown(collection) {
        var lastKeyDowns = {};
        return collection.map(function(key) {
          if (key.type === "key-down") {
            lastKeyDowns[key.code] = key;
            return false;
          } else {
            if (!lastKeyDowns[key.code])
              return false;
            return new KeyEvent(key.code, lastKeyDowns[key.code].timeStamp, key.timeStamp);
          }
        }).filter(function(key) {
          return !!key;
        });
      }

      _keyWasDown(e) {
        // if (this.history.addEvent(e)) {
          // this.dispatchEvent(new CustomEvent("pressed-keys", {
          //   "bubbles": true,
          //   "composed": true
          // }));
        // }
      }

      _keyWasUp(e) {
        // if (this.history.addEvent(e)) {
          // this.dispatchEvent(new CustomEvent("unpressed-keys", {
          //   "bubbles": true,
          //   "composed": true
          // }));
        // }
      }

      getHistory() {
        return this.keyEvents;
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>