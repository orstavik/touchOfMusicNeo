<dom-module id="keyboard-listener">
  <script>

    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }

      static get config() {
        return {
          properties: {
            lastKeyAction: {
              type: Object,
              value: function () {
                return {};
              }
            },
            heldKeys: {
              type: Object,
              value: function () {
                return {};
              }
            },
          }
        }
      }

      constructor() {
        super();
        window.addEventListener("keydown", this._catchNativeKeyBoardEvents.bind(this));
        window.addEventListener("keyup", this._catchNativeKeyBoardEvents.bind(this));
      }

      _catchNativeKeyBoardEvents(e) {
        KeyboardListener.preventCertainDefaultAction(e);
        let name = e.type.substr(0, 3) + "-" + e.type.slice(3);
        this.dispatchEvent(new CustomEvent(name, {
          "composed": true,
          "bubbles": true,
          "detail": {keyboardEvent: e, heldKeys: this.getHeldKeysRightNow(), code: e.code}
        }));
        if (e.type == "keydown")
          this._keyWasDown(e);
        if (e.type == "keyup")
          this._keyWasUp(e);
      }

      _keyWasDown(e) {
        if (this.isRepeatKeyEvent(e))
          return;
        if ((Object.keys(this.heldKeys).length === 0) && this.prevKeyEvent.timeStamp) {
          this.dispatchEvent(new CustomEvent("key-pause-end", {
            "composed": true,
            "bubbles": true,
            "detail": {duration: e.timeStamp - this.prevKeyEvent.timeStamp}
          }));
        }
        this.prevKeyEvent = e;
        this.heldKeys[e.code] = e;
      }

      isRepeatKeyEvent(e) {
        return this.prevKeyEvent.type === e.type && this.prevKeyEvent.code === e.code;
      }

      _keyWasUp(e) {
        this.prevKeyEvent = e;
        let correspondingDown = this.heldKeys[e.code];
        if (!correspondingDown)
          return;
        let keyE = new KeyEvent(e.code, correspondingDown.timeStamp, e.timeStamp);
        delete this.heldKeys[e.code];
        this.dispatchEvent(new CustomEvent("key-stroke", {"composed": true, "bubbles": true, detail: keyE}));
      }

      getHeldKeysRightNow(){
        return Object.keys(this.heldKeys);
      }

      static preventCertainDefaultAction(e) {
        let c = e.code;
        if (c == "Tab" || c == "Enter" || c == "ShiftLeft" || c == "Backquote" || c == "Backspace")
          e.preventDefault();
        e.stopPropagation();
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>