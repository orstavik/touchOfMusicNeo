<link rel="import" href="keyevents-listener.html">

<dom-module id="keyboard-listener">
  <template>
	<style>
		:host {
			display: none;
		}
	</style>

    <keyevents-listener on-key-down="_keyWasDown" on-key-up="_keyWasUp"></keyevents-listener>

  </template>

  <script>
    class KeyboardListener extends Polymer.Element {
      static get is() {
        return "keyboard-listener";
      }
      static get config() {
        return {
          properties: {
            pressedKeys: {
              type: Object,
              value: function() {
                return {
                  keys: [],
                  conditionals: []
                };
              }
            }
          }
        }
      }

      connectedCallback() {
        setInterval(function(){
          if (this.pressedKeys.length !== 0) {
            this._fireEvent("pressed-keys", this.pressedKeys);
          }
        }.bind(this), 1000/20);
      }

      _keyWasDown(e) {
        var key = e.code;
        this._fireEvent("key-pressed", key);

        if (key == "ShiftLeft") {
          if (this.pressedKeys.conditionals.indexOf(key) == -1)
            this.pressedKeys.conditionals.push(key);
        } else if (this.pressedKeys.keys.indexOf(key) === -1) 
          this.pressedKeys.keys.push(key);

        // this._fireEvent("pressed-keys", this.pressedKeys);
      }

      _keyWasUp(e) {
        var key = e.code;
        this._fireEvent("key-unpressed", key);

        if (key == "ShiftLeft") {
          var index = this.pressedKeys.conditionals.indexOf(key);
          if (index !== -1)
            this.pressedKeys.conditionals.splice(index,1);
        }
        var index = this.pressedKeys.keys.indexOf(key);
        if (index !== -1)
          this.pressedKeys.keys.splice(index,1);
        
        this._fireEvent("pressed-keys", this.pressedKeys);
      }
      
      _fireEvent(name, keys) {
        var _event = new CustomEvent(name, {"detail": {pressed: keys}, "bubbles": true, "composed": true});
        this.dispatchEvent(_event);
      }
    }
    customElements.define(KeyboardListener.is, KeyboardListener);
  </script>
</dom-module>