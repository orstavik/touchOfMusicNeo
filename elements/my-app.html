<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="letter-catcher.html">
<link rel="import" href="tempo-timer.html">
<link rel="import" href="joievent-player.html">
<link rel="import" href="game-judge.html">
<link rel="import" href="joievent-canon.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="audio-container.html">
<link rel="import" href="key-visual.html">
<link rel="import" href="key-leaf.html">
<link rel="import" href="key-flower.html">
<link rel="import" href="keyboard-visual.html">
<link rel="import" href="beam-constructor.html">
<link rel="import" href="monster-container.html">
<link rel="import" href="html-loader.html">
<link rel="import" href="music-clef-visual.html">
<link rel="import" href="music-clef.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100vh;
        background-image: url("../images/background/background.png");
        background-size: auto 100%;
        background-repeat: no-repeat;
        background-position: bottom;
      }
      #mapChoice {
        position: fixed;
        top: 20px;
        right: 20px;
        color: #ddd;
        font-weight: bold;
      }
    </style>

    <div id="mapChoice" style="width: 200px; height: 200px;">
      <key-flower tone-numbers="[[_getArrayForMe()]]" view-type="flower" scale="[[scale2]]"
                  style$="display: block; position: absolute; top: 25vh; left: 25vh;">[[scale2.key]] [[scale2.mode]]</key-flower>
      Play chords:<input type="checkbox" checked="{{chordMode::change}}"><br />
    </div>

    <iron-ajax url="../maps/keyboard/key-map.json"
               handle-as="json"
               on-response="_genKeyArray" auto></iron-ajax>

    <game-judge id="judge" input="[[scenario]]" chord-mode="[[chordMode]]">

      <joievent-player id="joiplayer">
        <letter-catcher id="scenario" tempo="[[tempo]]">
          <joievent-canon></joievent-canon>
        </letter-catcher>

        <beam-constructor id="beams">
          <keyboard-visual id="keyboard">
            <template is="dom-repeat" items="[[keyArray]]">
              <key-visual code$="[[item.code]]" tone="[[item.tone]]" octave="[[item.octave]]">
                <key-flower tone-numbers="[[_getArrayForMe4(item.tone)]]" scale="[[scale2]]"></key-flower>
                <!--<key-leaf tone-number="[[item.tone]]" scale="[[scale2]]"></key-leaf>-->
              </key-visual>
            </template>
            <joievent-canon></joievent-canon>
          </keyboard-visual>
          <monster-container id="monster"></monster-container>
        </beam-constructor>
      </joievent-player>

      <tempo-timer tempo="[[tempo]]" id="timer"></tempo-timer>

      <keyboard-listener></keyboard-listener>

      <audio-container id="audioPlayer">
        <music-clef id="clef" octave="4" mode="{{mode}}" key="{{key}}" scale2="{{scale2}}"></music-clef>
      </audio-container>

    </game-judge>

  </template>

  <script>
    class MyApp extends Polymer.Element {
      static get is() {
        return "my-app";
      }
      static get config() {
        return {
          properties: {
            scenario: {
              type: String,
              value:
                    "A@letter:A,duration:1 K@letter:K,duration:2 S@letter:S,duration:1 A! A!|A! K!|K!|K! A!|S! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A!",
                    // "O K U O K,10 J L K J L K Y I U Y I U T I U T I U",
            },
            tempo: {
              type: Number,
              value: 100
            },
            keyArray: {
              type: Array,
              value: function () {
                return []
              }
            },
            key: {
              type: String,
              value: "C"
            },
            mode: {
              type: String,
              value: "major"
            },
            chordMode: Boolean
          }
        }
      }

      _genKeyArray(e) {
        this.keyArray = e.detail.response;
        this.notifyPath("keyArray");
      }
      _getArrayForMe() {
        return [0,1,2,3,4,5,6];
      }
      _getArrayForMe2() {
        return [0,1];
      }
      _getArrayForMe3() {
        return [0,2,4,6];
      }
      _getArrayForMe4(tone) {
        return [0, Number(tone)];
      }
    }
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>