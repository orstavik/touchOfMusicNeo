<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="letter-catcher.html">
<link rel="import" href="tempo-timer.html">
<link rel="import" href="joievent-player.html">
<link rel="import" href="game-judge.html">
<link rel="import" href="joievent-canon.html">
<link rel="import" href="keyboard-listener.html">
<link rel="import" href="audio-container.html">
<link rel="import" href="key-visual.html">
<link rel="import" href="key-flower.html">
<link rel="import" href="key-leaf.html">
<link rel="import" href="keyboard-visual.html">
<link rel="import" href="beam-constructor.html">
<link rel="import" href="monster-container.html">
<link rel="import" href="html-loader.html">
<link rel="import" href="music-clef.html">
<link rel="import" href="color-palette.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100vh;
        background-image: url("../images/background/tree.png");
        background-size: auto 100%;
        background-repeat: no-repeat;
        background-position: bottom;
      }
      #mapChoice {
        position: fixed;
        top: 20px;
        right: 20px;
        color: #ddd;
        font-weight: bold;
      }
      #scenario {
        display: none;
      }
    </style>

    <div id="mapChoice">
      Play chords:<input type="checkbox" checked="{{chordMode::change}}"><br />
    </div>

    <key-flower scale="[[scale]]" palette="[[palette]]"></key-flower>

    <iron-ajax url="../maps/keyboard/key-map.json" handle-as="json" on-response="_genKeyArray" auto></iron-ajax>

    <game-judge id="judge" input="[[scenario]]" chord-mode="[[chordMode]]" scale="[[scale]]">

      <joievent-player id="joiplayer">
        <letter-catcher id="scenario" tempo="[[tempo]]">
          <joievent-canon></joievent-canon>
        </letter-catcher>

        <beam-constructor id="beams">
          <keyboard-visual id="keyboard">
            <template is="dom-repeat" items="[[keyArray]]">
              <key-visual code$="[[item.code]]" tone="[[item.tone]]" octave="[[item.octave]]">
                <template is="dom-repeat" items="[[_getArrayForMe4(item.tone, scale, palette)]]" as="info">
                  <key-leaf info="[[info]]" octave="[[item.octave]]"></key-leaf>
                </template>
              </key-visual>
            </template>
            <joievent-canon></joievent-canon>
          </keyboard-visual>
          <monster-container id="monster"></monster-container>
        </beam-constructor>
      </joievent-player>

      <tempo-timer tempo="[[tempo]]" id="timer"></tempo-timer>

      <keyboard-listener></keyboard-listener>

      <audio-container id="audioPlayer">
        <music-clef id="clef" octave="4" mode="major" key="C" scale="{{scale}}"></music-clef>
      </audio-container>

      <color-palette palette="{{palette}}" start-colors="[[startColors]]"></color-palette>

    </game-judge>

  </template>

  <script>
    class MyApp extends Polymer.Element {
      static get is() {
        return "my-app";
      }
      static get config() {
        return {
          properties: {
            scenario: {
              type: String,
              value:
                    "A@letter:A,duration:1 K@letter:K,duration:2 S@letter:S,duration:1 A! A!|A! K!|K!|K! A!|S! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A! K! K! K! A! A! A!",
                    // "O K U O K,10 J L K J L K Y I U Y I U T I U T I U",
            },
            tempo: {
              type: Number,
              value: 100
            },
            keyArray: {
              type: Array,
              value: function () {
                return []
              }
            },
            startColors: {
              type: Array,
              value: function() {
                return [
                    [5,100,50],
                    [35,100,50],
                    [50,100,50],
                    [60,100,50],
                    [90,100,49],
                    [120,100,45],
                    [150,100,40],
                    [180,100,35],
                    [210,100,50],
                    [225,100,50],
                    [310,100,40],
                    [340,100,45]
                  ]
              }
            },
            palette: Object,
            chordMode: Boolean
          }
        }
      }

      _genKeyArray(e) {
        this.keyArray = e.detail.response;
        this.notifyPath("keyArray");
      }
      _getArrayForMe4(tone, scale, palette) {
        if (palette) {
          var res = [0, Number(tone)].map(function(item) {
            return {
              number: scale.getTonePositionRelativeToKey(item),
              type: scale.getChordType(item),
              color: palette.getColor(scale.getToneColor(item))
            }
          })
          return res;
        }
      }
    }
    customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>