<dom-module id="running-text">
  <template>
    <style>
      :host {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 10px;
        height: 10px;
        margin: -5px 0 0 -5px;
        position: absolute;
        left: 50vw;
        top: 144vh;
      }
      #rotater {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        transform-origin: center;
      }
      .curvedChar {
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        width: 100%;
        height: 100%;
        font-size: 3.5vh;
        font-weight: bold;
        color: rgba(0,0,0,0.75);
        font-family: 'Ubuntu Mono', monospace;
        animation-fill-mode: forwards;
      }
      .innerChar {
        transition-duration: 0.5s;
        cursor: default;
      }
      #hitArea {
        display: inline-block;
        position: absolute;
        width: 6vh;
        height: 5vh;
        border-left: 3px solid rgba(0,255,0,0.75);
        border-right: 3px solid rgba(0,255,0,0.75);
        background: rgba(0,255,0,0.25);
        transform: translateY(-133.4vh);
      }
      @keyframes Run {
        from {transform: rotate(-21deg)}
        to {transform: rotate(339deg)}
      }
      @keyframes Appear {
        0% {opacity: 0}
        33% {opacity: 1}
        67% {opacity: 1}
        100% {opacity: 0}
      }
    </style>

    <div id="rotater">
      <template is="dom-repeat" items="[[_stringToArray(text)]]">
        <span class="curvedChar" style$="[[_rotateChar(index)]]" char$="[[item]]" on-animationend="_deleteMe">
          <span class="innerChar">[[item]]</span>
        </span>
      </template>
    </div>
    <div id="hitArea"></div>

  </template>
	
  <script>
    class RunningText extends Polymer.Element {
      static get is() {
        return "running-text";
      }
      static get config() {
        return {
          properties: {
            text: {
              type: String,
              value: ""
            },
            time: Number,
            tempo: Number,
            x: {
              type: Number,
              value: 2
            },
            i: {
              type: Number,
              value: 0
            },
            pressed: {
              type: Array,
              observer: "_findKey"
            },
						keyValues: {
							type: Object,
							value: function() {
								return {
									KeyA: {key: 'a', shiftKey: 'A'},
									KeyB: {key: 'b', shiftKey: 'B'},
									KeyC: {key: 'c', shiftKey: 'C'},
									KeyD: {key: 'd', shiftKey: 'D'},
									KeyE: {key: 'e', shiftKey: 'E'},
									KeyF: {key: 'f', shiftKey: 'F'},
									KeyG: {key: 'g', shiftKey: 'G'},
									KeyH: {key: 'h', shiftKey: 'H'},
									KeyI: {key: 'i', shiftKey: 'I'},
									KeyJ: {key: 'j', shiftKey: 'J'},
									KeyK: {key: 'k', shiftKey: 'K'},
									KeyL: {key: 'l', shiftKey: 'L'},
									KeyM: {key: 'm', shiftKey: 'M'},
									KeyN: {key: 'n', shiftKey: 'N'},
									KeyO: {key: 'o', shiftKey: 'O'},
									KeyP: {key: 'p', shiftKey: 'P'},
									KeyQ: {key: 'q', shiftKey: 'Q'},
									KeyR: {key: 'r', shiftKey: 'R'},
									KeyS: {key: 's', shiftKey: 'S'},
									KeyT: {key: 't', shiftKey: 'T'},
									KeyU: {key: 'u', shiftKey: 'U'},
									KeyV: {key: 'v', shiftKey: 'V'},
									KeyW: {key: 'w', shiftKey: 'W'},
									KeyX: {key: 'x', shiftKey: 'X'},
									KeyY: {key: 'y', shiftKey: 'Y'},
									KeyZ: {key: 'z', shiftKey: 'Z'},
									Digit0: { key: '0', shiftKey: ')' },
									Digit1: { key: '1', shiftKey: '!' },
									Digit2: { key: '2', shiftKey: '@' },
									Digit3: { key: '3', shiftKey: '#' },
									Digit4: { key: '4', shiftKey: '$' },
									Digit5: { key: '5', shiftKey: '%' },
									Digit6: { key: '6', shiftKey: '^' },
									Digit7: { key: '7', shiftKey: '&' },
									Digit8: { key: '8', shiftKey: '*' },
									Digit9: { key: '9', shiftKey: '(' },
									Equal: { key: '=', shiftKey: '+' },
									Minus: { key: '-', shiftKey: '_' },
									Semicolon: {key: ';', shiftKey: ':'},
									Comma: {key: ',', shiftKey: '<'},
									Period: {key: '.', shiftKey: '>'},
									Slash: {key: '/', shiftKey: '?'},
									BracketLeft: {key: '[', shiftKey: '{'},
									BracketRight: {key: ']', shiftKey: '}'},
									Quote: {key: '\'', shiftKey: '"'}
								}
							}
						},
          }
        }
      }

      connectedCallback() {
        this.$.rotater.style.animation = "Run "+360/this.x*this.tempo+"ms linear infinite";
      }

      resetRotation() {
        this.$.rotater.style.animation = "";
        setTimeout(function() {
          this.$.rotater.style.animation = "Run "+360/this.x*this.tempo+"ms linear infinite"
        }.bind(this), 0);
      }

      _stringToArray(text) {
        if (!text) return null;
        var array = [];
        for(var i = 0; i < text.length; i++) {
          array.push(text[i]);
        }
        return array;
      }

      _rotateChar(index) {
        var angle = -index*this.x;
        angle = angle%360;
        return "transform: rotate("+angle+"deg) translateY(-133.5vh);"+
               "animation: Appear "+38/this.x*this.tempo+"ms linear;";
      }

      _deleteMe(e) {
        for (var i = 0; i >= 0; i++) {
          var prev = e.target.previousElementSibling;
          if (prev) {
            prev.remove();
          } else {
            break;
          }
        }
        e.target.remove();
      }

      _findKey() {
        var hitRect = this.$.hitArea.getBoundingClientRect();
        var keys = this.pressed;
        for (var i = 0; i < keys.length; i++) {
          var key = this.keyValues[keys[i]]
          if (!key) break;
          key = key.key.toUpperCase();
          var nodes = this.$.rotater.querySelectorAll('[char="'+key+'"]');
          for(var j = 0; j < nodes.length; j++) {
            var rect = nodes[j].getBoundingClientRect();
            if (rect.left > hitRect.left && rect.right < hitRect.right) {
              this._success(nodes[j]);
            }
          }
        }
      }

      _success(node) {
        node.children[0].style.cssText = 
          "transform: scale(3);"+
          "opacity: 0;";
      }
    }
    customElements.define(RunningText.is, RunningText);
  </script>
</dom-module>