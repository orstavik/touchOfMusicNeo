<link rel="import" href="monster-part.html">

<dom-module id="monster-container">
  <template>
    <style>
      :host {
        display: inline-block;
        position: absolute;
        bottom: 7vh;
        left: 50%;
      }
    </style>

    <iron-ajax url="../maps/pinkRobot/sketch.json"
               handle-as="json"
               on-response="_robotLoaded" auto></iron-ajax>
    <template is="dom-repeat" items="[[json.parts]]">
      <monster-part letter$="[[item.letter]]" info="[[item]]" id$="[[item.id]]"></monster-part>
    </template>

  </template>
	
  <script>
    class MonsterContainer extends Polymer.Element {
      static get is() {
        return "monster-container";
      }
      static get config() {
        return {
          properties: {
            json: {
              type: String,
              value: function() {
                return {}
              }
            },
          }
        }
      }

      _robotLoaded(e) {
        let json = e.detail.response;
        let base;
        this.json = {
          metadata: {
            title: json.metadata.title,
            width: json.metadata.width,
            height: json.metadata.height
          },
          parts: json.actions.filter(function(item) {
              if (item.type == "ellipse") {
                base = {
                  x: item.bbox.x,
                  y: item.bbox.y,
                  width: item.bbox.width * item.bbox.scale.x,
                  height: item.bbox.height * item.bbox.scale.y,
                }
              } else if (item.type == "image") return true;
            }).map(function(item, index) {
              return {
                id: "part"+index,
                src: item.src.replace("#", ""),
                x: item.bbox.x - (base.x + base.width/2),
                y: item.bbox.y - (base.y + base.height/2),
                width: item.bbox.width,
                height: item.bbox.height,
                scale: item.bbox.scale,
                rotate: item.bbox.rotate,
                zIndex: item.zIndex
              }
            })
        }
        console.log(this.json, base);
      }

      getPart() {
        var node = this.shadowRoot.querySelector("monster-part[empty]");
        if (node) {
          node.empty = false;
          return node;
        }
      }
    }
    customElements.define(MonsterContainer.is, MonsterContainer);
  </script>
</dom-module>